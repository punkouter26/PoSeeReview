@page "/"
@using Po.SeeReview.Client.Services
@using Po.SeeReview.Client.Components
@using Po.SeeReview.Shared.Dtos
@inject GeolocationService GeolocationService
@inject UserPreferencesService UserPreferencesService
@inject ApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>PoSeeReview - Discover Strange Restaurant Stories</PageTitle>

<div class="index-container">
    <header class="app-header">
        <h1>üçΩÔ∏è PoSeeReview</h1>
        <p class="tagline">Discover the strangest restaurant stories near you</p>
    </header>

    @if (!_locationGranted && !_locationDenied && !_isLoading)
    {
        <div class="location-prompt">
            <div class="prompt-card">
                <h2>üìç Find Nearby Restaurants</h2>
                <p>We need your location to discover restaurants with strange reviews</p>
                <button class="btn-primary" @onclick="RequestLocationAsync">
                    Enable Location
                </button>
            </div>
        </div>
    }

    @if (_isLoading)
    {
        <LoadingIndicator Message="@_loadingMessage" />
    }

    @if (_locationDenied)
    {
        <div class="error-message">
            <h2>‚ùå Location Access Denied</h2>
            <p>@_errorMessage</p>
            <p>No problem! You can still search for restaurants manually.</p>
            
            <div class="manual-location-section">
                <h3>Enter Your Location</h3>
                <LocationInput 
                    Placeholder="Enter city name or ZIP code..." 
                    OnLocationSubmit="HandleManualLocationSearch" />
            </div>
            
            <div class="divider">OR</div>
            
            <button class="btn-secondary" @onclick="RequestLocationAsync">
                Try Automatic Location Again
            </button>
        </div>
    }

    @if (_hasError && !_locationDenied)
    {
        <div class="error-message">
            <h2>‚ö†Ô∏è Something Went Wrong</h2>
            <p>@_errorMessage</p>
            
            <div class="manual-location-section">
                <h3>Try Manual Search</h3>
                <LocationInput 
                    Placeholder="Enter city name or ZIP code..." 
                    OnLocationSubmit="HandleManualLocationSearch" />
            </div>
            
            <div class="divider">OR</div>
            
            <button class="btn-secondary" @onclick="RequestLocationAsync">
                Retry Automatic Location
            </button>
        </div>
    }

    @if (_restaurants.Count > 0)
    {
        <div class="restaurants-grid">
            <p class="results-info">Found @_totalCount restaurants near you</p>
            @foreach (var restaurant in _restaurants)
            {
                <RestaurantCard 
                    Restaurant="restaurant" 
                    OnRestaurantClick="HandleRestaurantClick" />
            }
        </div>
    }
</div>

@code {
    private bool _locationGranted = false;
    private bool _locationDenied = false;
    private bool _isLoading = false;
    private bool _hasError = false;
    private string _loadingMessage = "Getting your location...";
    private string _errorMessage = string.Empty;
    private List<RestaurantDto> _restaurants = new();
    private int _totalCount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Check if user previously granted location permission
        var locationEnabled = await UserPreferencesService.IsLocationEnabledAsync();
        
        if (locationEnabled)
        {
            // Automatically fetch location and load restaurants
            await RequestLocationAsync();
        }
    }

    private async Task RequestLocationAsync()
    {
        _isLoading = true;
        _hasError = false;
        _locationDenied = false;
        _loadingMessage = "Getting your location...";
        StateHasChanged();

        try
        {
            var result = await GeolocationService.GetCurrentPositionAsync();

            if (!result.Success)
            {
                _locationDenied = result.ErrorMessage.Contains("denied", StringComparison.OrdinalIgnoreCase);
                _errorMessage = result.ErrorMessage;
                _hasError = true;
                
                // If denied, clear the saved preference
                if (_locationDenied)
                {
                    await UserPreferencesService.SetLocationEnabledAsync(false);
                }
                
                return;
            }

            _locationGranted = true;
            
            // Save user preference that location is enabled
            await UserPreferencesService.SetLocationEnabledAsync(true);
            
            _loadingMessage = "Finding nearby restaurants...";
            StateHasChanged();

            await LoadNearbyRestaurantsAsync(result.Latitude, result.Longitude);
        }
        catch (Exception)
        {
            _errorMessage = "Unable to access your location. Please try again.";
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadNearbyRestaurantsAsync(double latitude, double longitude)
    {
        try
        {
            var response = await ApiClient.GetNearbyRestaurantsAsync(latitude, longitude);

            if (response == null || response.Restaurants.Count == 0)
            {
                _errorMessage = "No restaurants found nearby. Try a different location.";
                _hasError = true;
                return;
            }

            _restaurants = response.Restaurants;
            _totalCount = response.TotalCount;
        }
        catch (Exception)
        {
            _errorMessage = "Failed to load restaurants. Please try again later.";
            _hasError = true;
        }
    }

    private void HandleRestaurantClick(RestaurantDto restaurant)
    {
        // Navigate to comic view page (to be implemented in Phase 4)
        Navigation.NavigateTo($"/comic/{restaurant.PlaceId}");
    }

    private async Task HandleManualLocationSearch(string locationQuery)
    {
        _isLoading = true;
        _hasError = false;
        _locationDenied = false;
        _loadingMessage = $"Searching for restaurants near '{locationQuery}'...";
        StateHasChanged();

        try
        {
            // Call API with manual location query
            var response = await ApiClient.SearchRestaurantsByLocationAsync(locationQuery);

            if (response == null || response.Restaurants.Count == 0)
            {
                _errorMessage = $"No restaurants found near '{locationQuery}'. Try a different location.";
                _hasError = true;
                return;
            }

            _restaurants = response.Restaurants;
            _totalCount = response.TotalCount;
            _locationGranted = true; // Mark as successful search
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to search '{locationQuery}': {ex.Message}";
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}
