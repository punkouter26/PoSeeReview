@page "/"
@using Po.SeeReview.Client.Services
@using Po.SeeReview.Shared.Dtos
@using Microsoft.JSInterop
@inject GeolocationService GeolocationService
@inject IJSRuntime JS
@inject ApiClient ApiClient
@inject NavigationManager Navigation

<PageTitle>PoSeeReview - Discover Strange Restaurant Stories</PageTitle>

<div class="index-container">
    <header class="app-header">
        <h1>PoSeeReview</h1>
        <p class="tagline">Discover the strangest restaurant stories near you</p>
    </header>

    @if (!_locationGranted && !_locationDenied && !_isLoading)
    {
        <div class="location-prompt">
            <FluentCard class="prompt-card">
                <h2>Find Nearby Restaurants</h2>
                <p>We need your location to discover restaurants with strange reviews</p>
                <FluentButton Appearance="Appearance.Accent" @onclick="RequestLocationAsync">
                    Enable Location
                </FluentButton>
            </FluentCard>
        </div>
    }

    @if (_isLoading)
    {
        <LoadingIndicator Message="@_loadingMessage" />
    }

    @if (_locationDenied)
    {
        <div class="location-search-fallback">
            <FluentCard class="prompt-card">
                <h2>Search by Location</h2>
                <p>Enter a city name or ZIP code to discover restaurants with strange reviews</p>
                <div class="search-row">
                    <FluentTextField @bind-Value="_searchQuery" Placeholder="e.g. Seattle, 10001, Chicago" @onkeydown="HandleSearchKeyDown" />
                    <FluentButton Appearance="Appearance.Accent" @onclick="SearchByLocationAsync" Disabled="@(string.IsNullOrWhiteSpace(_searchQuery))">
                        Search
                    </FluentButton>
                </div>
                <p class="hint-text">Or <a href="#" @onclick="RequestLocationAsync" @onclick:preventDefault>try enabling location</a> again.</p>
            </FluentCard>
        </div>
    }

    @if (_hasError && !_locationDenied)
    {
        <div class="error-message">
            <h2>Something Went Wrong</h2>
            <p>@_errorMessage <a href="#" @onclick="RequestLocationAsync" @onclick:preventDefault>Try again</a></p>
        </div>
    }

    @if (_restaurants.Count > 0)
    {
        <div class="restaurants-grid">
            <p class="results-info">Found @_totalCount restaurants near you</p>
            @foreach (var restaurant in _restaurants)
            {
                <RestaurantCard 
                    Restaurant="restaurant" 
                    OnRestaurantClick="HandleRestaurantClick" />
            }
        </div>
    }
</div>

@code {
    private bool _locationGranted = false;
    private bool _locationDenied = false;
    private bool _isLoading = false;
    private bool _hasError = false;
    private string _loadingMessage = "Getting your location...";
    private string _errorMessage = string.Empty;
    private List<RestaurantDto> _restaurants = new();
    private int _totalCount = 0;
    private string _searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Check if user previously granted location permission
        var storedValue = await JS.InvokeAsync<string?>("localStorage.getItem", "posee_location_enabled");
        var locationEnabled = storedValue == "true";
        
        if (locationEnabled)
        {
            // Automatically fetch location and load restaurants
            await RequestLocationAsync();
        }
    }

    private async Task RequestLocationAsync()
    {
        _isLoading = true;
        _hasError = false;
        _locationDenied = false;
        _loadingMessage = "Getting your location...";
        StateHasChanged();

        try
        {
            var result = await GeolocationService.GetCurrentPositionAsync();

            if (!result.Success)
            {
                _locationDenied = result.ErrorMessage.Contains("denied", StringComparison.OrdinalIgnoreCase);
                _errorMessage = result.ErrorMessage;
                _hasError = true;
                
                // If denied, clear the saved preference
                if (_locationDenied)
                {
                    await JS.InvokeVoidAsync("localStorage.setItem", "posee_location_enabled", "false");
                }
                
                return;
            }

            _locationGranted = true;
            
            // Save user preference that location is enabled
            await JS.InvokeVoidAsync("localStorage.setItem", "posee_location_enabled", "true");
            
            _loadingMessage = "Finding nearby restaurants...";
            StateHasChanged();

            await LoadNearbyRestaurantsAsync(result.Latitude, result.Longitude);
        }
        catch (Exception)
        {
            _errorMessage = "Unable to access your location. Please try again.";
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadNearbyRestaurantsAsync(double latitude, double longitude)
    {
        try
        {
            var response = await ApiClient.GetNearbyRestaurantsAsync(latitude, longitude);

            if (response == null || response.Restaurants.Count == 0)
            {
                _errorMessage = "No restaurants found nearby. Try a different location.";
                _hasError = true;
                return;
            }

            _restaurants = response.Restaurants;
            _totalCount = response.TotalCount;
        }
        catch (Exception)
        {
            _errorMessage = "Failed to load restaurants. Please try again later.";
            _hasError = true;
        }
    }

    private async Task SearchByLocationAsync()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
            return;

        _isLoading = true;
        _hasError = false;
        _loadingMessage = $"Searching restaurants near {_searchQuery}...";
        StateHasChanged();

        try
        {
            var response = await ApiClient.SearchRestaurantsByLocationAsync(_searchQuery);

            if (response == null || response.Restaurants.Count == 0)
            {
                _errorMessage = "No restaurants found for that location. Try a different city or ZIP code.";
                _hasError = true;
                return;
            }

            _restaurants = response.Restaurants;
            _totalCount = response.TotalCount;
            _locationGranted = true;
            _locationDenied = false;
        }
        catch (Exception)
        {
            _errorMessage = "Failed to search restaurants. Please try again later.";
            _hasError = true;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSearchKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchByLocationAsync();
        }
    }

    private void HandleRestaurantClick(RestaurantDto restaurant)
    {
        Navigation.NavigateTo($"/comic/{restaurant.PlaceId}");
    }
}
