name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  AZD_ENVIRONMENT: 'prod'

# Required for OIDC authentication with Azure
permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal --filter "Category!=RequiresGoogleMapsAPI"
    
    - name: Install Azure Developer CLI
      run: |
        curl -fsSL https://aka.ms/install-azd.sh | bash
    
    - name: Azure Login (OIDC)
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Deploy with azd
      run: |
        azd config set auth.useAzCliAuth true
        azd provision --no-prompt
        azd deploy --no-prompt
      env:
        AZURE_ENV_NAME: ${{ env.AZD_ENVIRONMENT }}
        AZURE_LOCATION: eastus
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
